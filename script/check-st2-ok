#!/usr/bin/env bash
set -e
set -u
set -o pipefail

DIR=$( dirname "$(readlink -f "$0")" )
. $DIR/shared-functions

# Main entry point to check if st2 is installed properly
#
# @ init-check-st2-ok
init-check-st2-ok() {
    if executable-exists 'st2'; then
        if run-st2-core-local-check; then ok_message;
        else retry-message; exit 1;
        fi
    else retry-message; exit 2;
    fi
}

# shows a retry message in the event of a failure to boostrap,
# encouraging the user to try-again on convergence.
#
# @ retry-message
retry-message() {
    local _st2_datacenter=
    local _kick_command=
    _st2_datacenter="$(
    _st2_datacenter="$(facter datacenter)"

    if string-equal $_st2_datacenter "vagrant";
    then _kick_command="$(kick-command-vagrant)"
    elif update-system-command-is-present;
    then _kick_command="$(kick-command-update-system)"
    else _kick_command="$(kick-command-bootstrap-st2)"
    fi

    echo ""
    echo "OH NOES!"
    echo "Don't worry! Occasionally something goes wrong, and you just have"
    echo "to kick the tires a bit. Try re-provisioning by executing the command:"
    echo ""
    echo "${_kick_command}"
    echo ""
    echo "If you don't happen to get the 'OK' after that, give us a shout!"
    echo "We don't want to leave you hanging! Come find your favorite way to"
    echo "contact us, and we'll get you going faster than you can say..."
    echo "AUTOMATE ALL THE THINGS!"
    echo
    st2-support-contact-information
}

ok_message() {
    local _st2_ip=
    local _st2_fqdn=
    _st2_ip="$(facter st2_ip)"
    _st2_fqdn="$(facter fqdn)"

    echo ""
    echo ""
    echo "███████╗████████╗██████╗      ██████╗ ██╗  ██╗";
    echo "██╔════╝╚══██╔══╝╚════██╗    ██╔═══██╗██║ ██╔╝";
    echo "███████╗   ██║    █████╔╝    ██║   ██║█████╔╝ ";
    echo "╚════██║   ██║   ██╔═══╝     ██║   ██║██╔═██╗ ";
    echo "███████║   ██║   ███████╗    ╚██████╔╝██║  ██╗";
    echo "╚══════╝   ╚═╝   ╚══════╝     ╚═════╝ ╚═╝  ╚═╝";
    echo ""
    echo "  st2 is installed and ready to use."
    echo ""
    echo "First time starting this machine up?"
    echo "Visit https://${_st2_ip}/setup to configure StackStorm"
    echo "Otherwise, head to https://${_st2_fqdn} to access the WebUI"
    echo ""
    echo "If you would like to use the CLI interface, you will need"
    echo "to ensure that StackStorm environment variables are properly"
    echo "set. You can do this by logging out and logging back in, or"
    echo "running the command:"
    echo ""
    echo ". /etc/profile.d/st2.sh"
    echo ""
    echo "Don't forget to dive into our documentation! Here are some resources"
    echo "for you:"
    echo ""
    echo "* Documentation  - https://docs.stackstorm.com"
    echo "* Knowledge Base - https://stackstorm.reamaze.com"
    echo ""
    st2-support-contact-information
}

init-check-st2-ok
