#!/usr/bin/env bash
set -e
set -u
set -o pipefail

DIR=$( dirname "$(readlink -f "$0")" )
source $DIR/shared-functions

source "$(project-root)/script/lib/puppet-apply.d/help"
source "$(project-root)/script/lib/puppet-apply.d/environment"

# bootstraps the AIO system to ensure that any necessary libraries
# are installed and ready to go
#
# @ bootstrap-aio
bootstrap-aio() {
    if local-development-mode;
    then setup-current-working-directory-environment
    else setup-environment-from-git-branch
    fi

    install-puppetfile
}

# function that downloads a the puppet-st2 project and sets it up
# to be tested/used during development
bootstrap-puppet-st2() {
    local _repo=
    local _module_dir=
    local _module_backup_dir=
    local _git_stage_dir=
    _repo="https://github.com/stackstorm/st2.git"
    _module_dir="$(environment-dir)/modules/st2"
    _module_backup_dir="$(random-tmpdir)"
    _git_stage_dir="$(random-tmpdir)"

    git-safe-clone $_repo $_git_stage_dir "$(puppet-st2-version)"
    safe-copy $_git_stage_dir $_module_dir
}

# Main init
init-puppet-apply() {
    if ! is-root; then
        show-help
        fail-loudly "Please run with root permissions"
    fi

    run-bootstrap-os
    git-update-and-clean $(project-root)
    run-preflight-os
    bootstrap-aio

    if install-puppet-st2-branch;
    then bootstrap-puppet-st2
    fi

    run-puppet
}

# Main entry point for script
while :; do
    case $1 in
        -h|-\?|--help)
            show_help
            exit
            ;;
        -v|--verbose)
            AIO_LOG_LEVEL=verbose
            shift
            continue
            ;;
        -d|--debug)
            AIO_LOG_LEVEL=debug
            DEBUG=true
            shift
            continue
            ;;
        -e|--environment)
            if [ -n "$2" ]; then
                ENV=$2
                shift 2
                continue
            else
                printf 'ERROR "--environment" requires a non-empty argument.\n'
            fi
            ;;
        -s|--st2-puppet-branch)
            if [ -n "$2" ]; then
                PUPPET_ST2_BRANCH=$2
                shift 2
                continue
            else
                printf 'ERROR "--st2-puppet-branch" requires a non-empty argument.\n'
            fi
            ;;
        -t|--trace)
            TRACE=true
            set -x
            shift
            continue
            ;;
        -f|--force)
            FORCE=true
            shift
            continue
            ;;
        --)
            shift
            break
            ;;
        -?*)
            printf "WARN: unknown option ($1)... ignoring.\n"
            ;;
        *)
            break
    esac
    shift
done

init-puppet-apply
